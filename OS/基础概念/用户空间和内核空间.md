#Kernel-space #User-space #Todo 

# 背景

- CPU 指令中*有些是非常危险*的，错用将导致系统崩溃，比如*清内存、设置时钟*等。
- 如果允许所有的程序都可以使用这些指令，系统崩溃的概率将大大增加。  
- 所以，CPU 将指令分为**特权指令和非特权指令**：
	- 可能带来危险的指令，只允许操作系统及其相关模块使用；
	- 普通应用程序只能使用非特权指令。
- 如 Intel 的 CPU 将特权等级分为 4 个级别：Ring0~Ring3。  
- Linux 系统只使用了 Ring0 和 Ring3 两个运行级别(Windows 系统也是一样的)：
	-  Ring3 级别状态称为用户态，Ring0 级别称为内核态。

# 概念
- Kernel space 是 Linux 内核的运行空间，User space 是用户程序的运行空间。
	- 在 32 bit OS 中最高 1G 为内核空间，剩下为用户空间
	- ![[32bit OS 内核和用户空间划分示意.png]]

- 为了操作系统安全，内核空间和用户空间是隔离的，用户的程序崩溃了，内核也不受影响。
- 当进程运行在内核空间时就处于内核态，当进程运行在用户空间时就处于用户态。
- Kernel space 可以执行任意命令，调用系统的一切资源；
- User space 只能执行简单的运算，不能直接调用系统资源，必须通过系统调用（又称 system call），才能向内核发出指令。

## 优点
- 对于 Linux ，区分内核空间和用户空间的设计，**隔离了操作系统与应用程序代码**(操作系统的代码要比应用程序的代码健壮很多)。
- 单个应用程序出现错误也*不影响到操作系统的稳定性*；
- 其它的程序还可以正常的运行。
- **区分内核空间和用户空间本质上是要提高操作系统的稳定性及可用性。**

# 从用户空间进入内核空间
- **所有的系统资源管理都是在内核空间中完成**
	- 比如**读写磁盘文件，分配回收内存，从网络接口读写数据**等等。
- 应用程序无法直接操作，可以通过内核提供的系统调用（system call）来完成。  
- 如应用程序要读取磁盘上的一个文件：
	1. 向内核发起一个 "系统调用" 告诉内核："我要读取磁盘上的某某文件"。
	2. 其实是通过一个特殊的指令让进程*从用户态进入到内核态(到了内核空间)*；
	3. 在内核空间中，CPU 可以执行任何的指令，当然可以从磁盘上读取数据。
		1. 先*把数据读取到内核空间*中；
		2. 然后再把数据*拷贝到用户空间*；
		3. 并*从内核态切换回到用户态*。
	4. 此时应用程序从系统调用中得到了想要的数据。  

- 对于一个进程来讲，从用户空间进入内核空间并最终返回到用户空间的过程是十分复杂的。
- 举个例子，比如其实*进程在内核态和用户态各有一个堆栈*。
- 运行在用户空间时进程使用的是用户空间中的堆栈，而运行在内核空间使用的是内核空间中的堆栈。
- 所以说，Linux 中**每个进程有两个栈**，分别用于用户态和内核态。

下图简明的描述了用户态与内核态之间的转换：
![[OS中从用户态到内核态的切换示意.png]]

- 从上可知，从用户态进入内核态，有三种方式：**系统调用、软中断（定时中断）和硬件中断**

# 整体结构
从内核空间和用户空间的角度看一看整个 Linux 系统的结构。它大体可以分为三个部分，从下往上依次为：硬件 -> 内核空间 -> 用户空间

![[从用户态和内核态看linux整体架构.png]]

- 在硬件( hardware )之上，内核空间中的代码控制了硬件资源的使用权；
- 用户空间中的代码只有通过内核暴露的系统调用接口(System Call Interface)才能使用到系统中的硬件资源；
- Windows 操作系统的设计也是大同小异。

## CPU 可能的活动
实际上我们可以将每个处理器在任何指定时间点上的活动概括为下列三者之一：
-   **运行于用户空间，执行用户进程。**
-   **运行于内核空间，处于进程上下文，代表某个特定的进程执行。**
-   **运行于内核空间，处于中断上下文，与任何进程无关，处理某个特定的中断。**

- 以上三点几乎包括所有的情况，比如当 CPU 空闲时，内核就运行一个 Idle 进程，处于进程上下文，但运行在内核空间。  
## 备注
- Linux 系统的中断服务程序不在进程的上下文中执行，它们在一个与所有进程都无关的、专门的中断上下文中执行。
- 是为了保证中断服务程序能够在**第一时间响应和处理中断请求**，然后快速地退出。

# 参考
1. [用户空间和内核空间是什么？](https://cloud.tencent.com/developer/article/1352415)
2. [Linux 内核空间与用户空间](https://www.cnblogs.com/sparkdev/p/8410350.html)