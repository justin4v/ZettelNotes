#Nacos #Dynamic-fluh

# 长轮询
从远端服务器获取变更数据的主要模式有两种：推（push）和拉（pull）。Push 模式简单来说就是服务端主动将数据变更信息推送给客户端，这种模式优点是时效性好，服务端数据发生变更可以立马通知到客户端，但这种模式需要服务端维持与客户端的心跳连接，会增加服务端实现的复杂度，服务端也需要占用更多的资源来维持与客户端的连接。

而 Pull 模式则是客户端主动去服务器请求数据，例如，每间隔10ms就向服务端发起请求获取数据。显而易见pull模式存在时效性问题。请求的间隔也不太好设置，间隔太短，对服务器请求压力过大。间隔时间过长，那么必然会造成时效性很差。而且如果配置长时间不更新，并且存在大量的客户端就会产生大量无效的pull请求。

Nacos 没有采用上述的两种模式，而是采用了长轮询方式结合了推和拉的优点：
![[nacos 长轮询示意.png]]

-   长轮询也是轮询，因此 Nacos 客户端会默认每10ms向服务端发起请求，当客户端请求服务端时会在请求头上携带长轮询的超时时间，默认是30s。而服务端接收到该请求时会hang住请求，为了防止客户端超时会在请求头携带的超时时间上减去500ms，因此默认会hang住请求29.5s。在这期间如果服务端发生了配置变更会产生相应的事件，监听到该事件后，会响应对应的客户端。这样一来客户端不会频繁发起轮询请求，而服务端也不需要维持与客户端的心跳，兼备了时效性和复杂度。


# nacos 动态刷新流程
![[nacos动态刷新流程.png]]



![[服务端长轮询机制示意.png]]


![[nacos 客户端长轮询机制示意.png]]


# 参考
1. [nacos如何实现配置加载与动态刷新配置](https://blog.csdn.net/qq_37436172/article/details/119971116)
2. [从源码角度一步步窥探Nacos配置拉取与动态刷新、监听原理](https://blog.csdn.net/China_eboy/article/details/112507139)
3. [Nacos Config 动态刷新源码剖析](https://www.jianshu.com/p/b446a695cc1e)