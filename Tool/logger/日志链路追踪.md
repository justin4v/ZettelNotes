#Trace #Logback #Todo 


# 背景
- 查看多线程服务日志时，当服务被调过于频繁，日志刷新太快，会影响到联调、测试、线上问题的排查效率；
- 能不能为每一个请求的日志打一个唯一标识？

# MDC
- **Mapped Diagnostic Context**，*映射诊断上下文*。
- MDC 是 `log4j` 和 `logback` 提供的一种可在多线程环境下，记录诊断日志的功能。
- MDC 可以看成是一个**与当前线程绑定的哈希表**，可以往其中添加键值对。

## 使用方法
​ 向MDC设置值：`MDC.put(key, value)`;
​ 从MDC中取值：`MDC.get(key);`
- 清除：`MDC.clear();`
​ 将MDC中的内容打印到日志中：`%X{key};`；
- `%X` 是一种日志输出 MDC 的模式(patternLayout)；

>**X**{_key:-defaultVal_}  
  **mdc**{_key:-defaultVal_}  
Outputs the MDC (mapped diagnostic context) associated with the thread that generated the logging event.
If the **mdc** conversion word is followed by a key between braces, as in **%mdc{userid}**, then the MDC value corresponding to the key 'userid' will be output. If the value is null, then the [default value](https://logback.qos.ch/manual/configuration.html#defaultValuesForVariables) specified after the **:-** operator is output. If no default value is specified than the empty string is output.
If no key is given, then the entire content of the MDC will be output in the format "key1=val1, key2=val2".


## 初始化TraceId并向MDC设置值
 
- 主要思想是在方法执行前设置MDC，方法执行后擦除MDC。
- **过滤器**实现；
- **拦截器**实现；
- **AOP**实现等等。
- 个人比较推荐 Filter 实现，因为Filter是请求最先碰到的，也是响应给前端前最后一个碰到的。
# 参考
1. [SpringBoot项目traceId生成/日志打印](https://blog.csdn.net/psy1286479613/article/details/121368058)
2. [Chapter 8: Mapped Diagnostic Context (qos.ch)](https://logback.qos.ch/manual/mdc.html)
3. [Chapter 6: Layouts (qos.ch)](https://logback.qos.ch/manual/layouts.html)