#Mysql #Transaction
# MySQL 事务

MySQL  **InnoDB 引擎**支持事务，**MyISAM 不支持事务**。

# 事务
- 一组原子性的 SQL 查询，**要么就是全部成功，要么全部失败**。

## 示例
假设一个银行的数据库有两张表：
- *支票（checking ) 表*和*储蓄（savings ）表*。
- 要从用户 Jane 的支票账户转移 200 美元到她的储蓄账户;
- 至少需要三步：
	1. 检查支票账户的余额是否高于 200 美元；
	2. 从支票账户余额中减去 200 美元。
	3. 在储蓄账户余额中增加 200 美元。
- 上述三个步骤必须打包在一个事务(transaction)中，任何一个步骤失败，必须回滚所有的步骤。

## 实际语句
- 用 `START TRANSACTION` 语句开始一个事务;
- 然后要么使用 `COMMIT` 提交事务将修改的数据持久保留;
- 要么使用 `ROLLBACK` 撤销所有的修改。
```sql
1. START TRANSACTION; 
2. SELECT balance FROM checking WHERE customer_id = 10233276; 
3. UPDATE checking SET balance = balance - 200.00 WHERE customer_id = 10233276; 
4. UPDATE savings SET balance = balance + 200.00 WHERE customer_id = 10233276; 
5. COMMIT;
```


# ACID
事务具有 ACID特性：
- **原子性**（Atomicity）：一个事务必须被视为一个不可分割的最小工作单元，整个事务中的所有操作要么全部提交成功，要么全部失败回滚；
- **一致性**（Consistency）：数据库总是从一个一致性的状态转换到另外一个一致性的状态；
- **隔离性**（Isolation）：一个事务所做的修改在最终提交以前，对其他事务是不可见的；
- **持久性**（Durability）：一旦事务提交，则其所做的修改就会永久保存到数据库中。


# 事务隔离级别
## 背景
- SQL 事务隔离级别的设计是为了*能最大限度的解决并发问题*

## 隔离级别
SQL 标准定义了四种隔离级别，MySQL 全都支持。这四种隔离级别分别是：
1. **读未提交（READ UNCOMMITTED）** ——RU
2. **读提交 （READ COMMITTED）** —— RC
3. **可重复读 （REPEATABLE READ）** —— RR
4. **串行化 （SERIALIZABLE）** ——SE

- 从上往下，**隔离强度逐渐增强，性能逐渐变差**；
- **可重复读**是 MySQL 的默认级别。

| 隔离级别 | 脏读   | 不可重复读 | 幻读   |
| -------- | ------ | ---------- | ------ |
| 读未提交 | 可能   | 可能       | 可能   |
| 读提交   | 不可能 | 可能       | 可能   |
| 可重复读 | 不可能 | 不可能     | 可能   |
| 串行化   | 不可能 | 不可能     | 不可能 |

串行化解决了全部这 3 个问题

# 并发问题
## 脏读
- 读到了其他事务未*提交（临时）数据*，这些数据可能回滚，可能提交。

**现象**
- 当前线程查询到了其他事务的中间过程的数据（临时数据）
- *写锁没有排它（排斥读锁）*。

## 不可重复读

- 在**同一事务内，不同的时刻读到的同一批数据可能是不一样**。
- 该数据可能受到了其他事务的影响。

**现象**
- 在更新数据前读到的数据和更新过程中读到的数据不同。
如更新事务：
```sql
update test set version=2 where id = 1 and version = 0;
```

事务开始前查询`id`为1的数据`version=0`，在更新过程中、提交之前某个时间，`version`变成了1（有其他线程同时在更新）。

- 同时有两个线程写数据库。

### 可重复读实现
*当前事务更新数据前，保存一份数据的快照，更新过程中读取快照*


## 幻读
- 幻读是针对数据**插入（INSERT）** 操作：

- 假设事务A对某些行的内容作了更改，但是还未提交；
- 事务B插入了与事务A更改前的记录相同的记录行，并且在事务A提交之前先提交了。

**现象**
当前线程正在删除（更新）某条记录，提交之前，查询发现*相同的记录又出现了*，好像刚刚的**更改未起作用**，让人感觉出现了幻觉，这就叫幻读。
- 同时有两个线程写数据库


