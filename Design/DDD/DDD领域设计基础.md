# DDD
## 目的
- 首先设计业务领域，明确业务需求，从最开始就让客户或者领域专家参与设计


### 1、聚合根
1）如果把聚合比作组织，聚合根则是组织的负责人，聚合根也叫做根实体，它不仅仅是实体，还是实体的管理者；

2）聚合根作为实体，具备自己的业务属性，业务行为，业务逻辑；

3）聚合根作为聚合的管理者，在聚合内部，负责协调实体和值对象按照固定的业务规则协同完成共同的业务逻辑；

4）在聚合之间：聚合根是聚合对外的接口人，以聚合根ID的方式接受外部请求和任务，实现上下文中的聚合之间的业务协同；

5）聚合之间通过聚合根ID关联引用，如果需要访问其他聚合的实体，先访问聚合根，再导航到聚合内部的实体；即聚合外部对象不能直接访问聚合内的实体；

6）聚合解决的问题： 复杂数据模型缺少统一的业务规则控制而导致的聚合，实体之间数据不一致的问题；

7）聚合根是实体，具备唯一标识，有独立的生命周期，一个聚合只有一个聚合根，聚合根在聚合之内采用对象引用依赖的方式对实体和值对象进行组织和协调，聚合根和聚合根之间通过唯一ID进行聚合之间的协同；

#### 注意
- 聚合根和聚合内其他实体的关系是整体和部分的关系，是 UML 里面**组合**的关系；
- 可以通过*聚合根访问聚合内的其他实体*；
- 聚合划分依据：*语义相关、功能相关*
- 聚合和聚合相关，通过聚合根 ID 关联，如在本聚合根中包含其他聚合根的 id。

### 2、实体
1）实体着重唯一性和延续性，不在意属性（阅读数、转发数）的变化，它还是原来那个它；

2）实体具备ID标识，可以通过ID进行相等性比较，实体在聚合内唯一，但是状态可变，它依附于聚合根，它的生命周期由聚合根管理，实体一般都会持久化，跟数据持久化对象（PO）存在多种对应关系（一对一，一对多，多对一，1对0），实体可以引用聚合中的聚合根，实体，值对象；

### 3、值对象
1）值对象着重描述性，对属性的变化很敏感，属性变了，它就不是原来那个它；

2）值对象无ID,不可变，无生命周期，用完即失效，值对象之间通过属性值判断相等性，他的核心是值，是一组概念完整的属性集合，用于描述实体的特征和状态，值对象尽量只引用值对象；

### 4、领域事件

1）领域事件发生在微服务内部，引入事件总线（EVENT BUS）；发生在微服务外部，引入消息中间件；

2）领域事件实体类放在领域层聚合的event目录结构下。领域事件的订阅建议放在应用层的event目录结构下。领域事件发布相关代码放在领域层或者应用层都可以。

### 5、领域服务
1）领域服务通过对多个实体各实体方法进行组合和编排，完成多个实体组合的核心业务逻辑；

2）跨多个实体的业务逻辑在聚合根方法和领域服务中都可以实现。建议将这类业务逻辑尽量放在领域服务中实现，避免聚合根内的业务逻辑过于庞杂；

3）一个聚合可以建立一个领域服务类，可以将聚合中所有的领域服务都在这个领域服务类中实现；

### 6、工厂和仓储
1）一个聚合只有一个仓储；

2）仓储包括仓储接口和仓储实现，通过依赖倒置（DIP）原则实现应用业务逻辑与数据库资源逻辑的解耦；

3）聚合可以通过工厂和仓储模式两者结合，完成聚合内实体和值对象等DO对象的构建、数据初始化和持久化；

### 7、持久化对象
1）持久化对象PO主要完成DO对象的数据库持久化操作，PO一般与数据库表是一对一的关系；

### 8、应用服务
1.  应用层主要是应用服务和领域事件的发布和订阅；
[应用服务和领域服务的区别](https://enterprisecraftsmanship.com/posts/domain-vs-application-services/)

2. 应用层服务参数：command、event、query或者简单情况下用 Id。
  

# DDD领域设计实践
## DDD设计思路
### 战略设计
- 从业务视角出发，建立业务领域模型；
- 划分领域边界，建立通用语言的限界上下文；
- 限界上下文可以作为微服务设计的参考边界。

- 业务领域可按照：核心领域、支撑领域、通用领域，划分边界；
- 但是领域都是业务相关的；
- 如风险控制在银行金融业务中一般是作为支撑领域，但是在一些领域可能就是核心领域。

### 战术设计
- 从技术视角出发，侧重于领域模型的技术实现，完成软件开发和落地；
- 包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现

## DDD设计方法
1.  一步：在事件风暴（或者*四色分析*）中梳理业务过程中的用户操作、事件以及外部依赖关系等，根据这些要素梳理出领域实体等领域对象。
    
2.  第二步：务紧密相关的实体进行组合形成聚合，同时确定聚合中的聚合根、值对象和实体。
    
3.  第三步：根据业务及语义边界等因素，将一个或者多个聚合划定在一个限界上下文内，形成领域模型。在这个图根据领域实体之间的业务关联性，将业里，限界上下文之间的边界是第二层边界，这一层边界可能就是未来微服务的边界，不同限界上下文内的领域逻辑被隔离在不同的微服务实例中运行，物理上相互隔离
    

# 总结
- 贫血对象和富对象

![[架构设计目标总结.png]]




# 参考文档

1. https://mp.weixin.qq.com/s/kpXklmidsidZEiHNw57QAQ

2. https://mp.weixin.qq.com/s/MU1rqpQ1aA1p7OtXqVVwxQ

3. https://mp.weixin.qq.com/s/1bcymUcjCkOdvVygunShmw

4. https://www.cnblogs.com/junzi2099/p/13682154.html
5. [应用服务和领域服务的区别](https://enterprisecraftsmanship.com/posts/domain-vs-application-services/)
6. [[DDD 业内实践]]