#DDD #Design 

# 后端架构演进
## 传统MVC架构

 ![[MVC架构.png]]
优点：关注前后端分离
缺点：模型层分层太粗，融合了数据处理、业务处理等所有的功能。核心的复杂业务逻辑都放到模型层，导致模型层很乱
适应场景：后端业务逻辑简单的服务，比如接口直接提供对数据库增删改查

## 后端三层架构 
![[后端三层架构.png]]

### 定义
1.  表现层：controller
2.  逻辑层：service
3.  数据访问层：dao
    
优点：逻辑与数据层分离
缺点：模型层分层比较粗，核心的复杂业务逻辑都放到模型层，导致模型层很乱
适应场景：后端业务逻辑简单的服务，比如接口直接提供对数据库增删改查

## 阿里分层架构
![[阿里分层架构.png]]
 
架构来源：参照阿里发布的《阿里巴巴 Java 开发手册 v1.4.0（详尽版）》，将原先的三层架构细化而来

特点：添加了Manager 通用业务处理层。

这一层有两个作用，一、可以将原先 Service 层的一些通用能力下沉到这一层，比如与缓存和存储交互策略，中间件的接入；二、也可以在这一层封装对第三方接口的调用，比如调用支付服务，调用审核服务等RPC接口。

优点：相比于三层方式，添加了通用处理层对接外部平台。上下游对接划分的比较清晰

缺点：核心业务逻辑层没有划分

适应场景：业务逻辑不复杂的常用业务

## DDD分层架构
整洁架构和六边形架构都是DDD架构的一种方式，只不过是视角不同。

### 整洁架构
特点：整洁架构的层就像洋葱片一样，它体现了分层的设计思想

整洁架构最主要的原则是依赖原则，它定义了各层的依赖关系，越往里依赖越低，代码级别越高，越是核心能力。外圆代码依赖只能指向内圆，内圆不需要知道外圆的任何情况。

![[整洁架构.png]]
 
 
## 六边形架构

六边形架构又名“端口适配器架构”。追溯微服务架构的渊源，一般都会涉及到六边形架构。

六边形架构的核心理念是：应用是通过端口与外部进行交互的。我想这也是微服务架构下API网关盛行的主要原因吧。

也就是说，在下图的六边形架构中，红圈内的核心业务逻辑（应用程序和领域模型）与外部资源（包括APP、Web应用以及数据库资源等）完全隔离，仅通过适配器进行交互。它解决了业务逻辑与用户界面的代码交错问题，很好地实现了前后端分离。六边形架构各层的依赖关系与整洁架构一样，都是由外向内依赖。

 ![[六边形架构.png]]
 
 
 DDD四层架构
- 从DDD理论架构（整洁架构/六边形架构）发展而来，而且还经历传统四层架构到优化后到四层架构的演进。最终形成如下图所示。
![[传统四层架构和依赖倒置的四层架构.png]] 
 
- 在最早的传统四层架构中，其它层都依赖于基础层，基础层位于核心位置；
- DDD 中领域层才是软件的核心，采用了依赖倒置（Dependency inversion principle,DIP）的设计，优化了传统的四层架构，实现了各层对基础层的解耦。

# DDD四层架构详解
![[DDD四层架构.png]]
 
 
## 分层定义
- *用户接口层*：用于提供统一对外的接口，同样一个应用服务可能用于不同的端，入参和出参不太一样，所以在上游添加一个用户接口层对不同格式入参出参进行处理，提供对应用服务层的复用。
- *应用层* ：对各个*领域服务或其他微服务的提供的接口进行编排*，协作完成业务操作。应用服务粒度较粗，需要注意可复用性。应用服务还可以进行安全认证、权限校验、事务控制、发送或订阅领域事件等。另外，应用层代码较薄，不包含业务规则或逻辑，主要是控制业务流程走向，逻辑部分委托给领域层。
- *领域层* ：主要包含实体类、值对象类、事件类、领域服务。领域服务供应用层调用，实现业务的规则和逻辑，但对于只与单一实体自己相关的一些动作，这部分逻辑由实体类自己来实现。
- *基础层* ：基础层是贯穿所有层的，它的作用就是为其它各层提供通用的技术和基础服务，包括第三方工具、驱动、消息中间件、网关、文件、缓存以及数据库等
    

## 特点
1.  数据、缓存等都视为基础层， 可以被所有层调用
2.  抽离了领域层，负责核心业务逻辑处理，领域层调用外部依赖全部通过接口，以保证领域层的100%单测覆盖率
3.  应用层聚合多个领域层的能力，只做功能的组合、转发，不负责具体业务逻辑

### 优点
相比于三层方式，更关注领域服务，即业务核心逻辑的划分、收敛
### 缺点
分层复杂， 如果业务逻辑简单没有必要
### 适应场景
*业务复杂的业务*

## 和传统三层架构的对比
![[DDD和传统三层架构对比.png]]
 
DDD四层架构也基于传统三层架构的，不同点有以下几方面：
1.  关注点不一样：三层架构关注请求调用顺序；DDD架构关注领域服务。
2.  横向划分方式不一样：三层架构主要关注纵向划分，对横向划分没有约定；DDD架构更关注纵向，即：多个领域层之间划分及交互方式。
3.  对资源的定位不一样：三层架构把所有依赖的数据都放到数据访问层；DDD架构只将领域强关联的数据放到Repository中，其他比如API层缓存、文件等都当成基础服务来处理。
    

## 小结

- DDD 分层架构对三层架构的业务逻辑层进行了更清晰的划分，改善了三层架构核心业务逻辑混乱，代码改动相互影响大的情况。
- DDD 分层架构将业务逻辑层的服务拆分到了应用层和领域层。应用层快速响应前端的变化，领域层实现领域模型的能力。
- 另外一个重要的变化发生在数据访问层和基础层之间。三层架构数据访问采用 DAO 方式；
- DDD 分层架构的数据库等基础资源访问，采用了仓储（Repository）设计模式，通过*依赖倒置*实现各层对基础资源的解耦。
- 仓储又分为两部分：
	- 仓储接口和仓储实现。
	- 仓储接口放在领域层中，仓储实现放在基础层。
- 原来三层架构通用的第三方工具包、驱动、Common、Utility、Config 等通用的公共的资源类统一放到了基础层

DDD四层架构，它实现了：
-   高内聚：分层的设计可以简化系统设计，让不同的层专注做某一模块的事
-   低耦合：层与层之间通过接口或API来交互，依赖方不用知道被依赖方的细节
-   复用：分层之后可以做到很高的复用
-   扩展性：分层架构可以让我们更容易做横向扩展
    

如果系统没有分层，当业务规模增加或流量增大时我们只能针对整体系统来做扩展。分层之后可以很方便的把一些模块抽离出来，独立成一个系统。

# 参考
1. [[DDD与微服务]]