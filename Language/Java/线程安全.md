# Threadsafe

A class  is _threadsafe_ if it *behaves correctly when used from multiple threads, regardless of how those threads are executed, and without demanding additional coordination from the calling code*.

1. “Behaves correctly” ： *satisfying its specification and preserving its response invariant*；
2. “Regardless of how threads are executed” ： threads might be on multiple processors or timesliced on the same processor；
3. “without additional coordination” ： *can’t put preconditions* on its caller related to timing, like “you can’t call `get()` while `set()` is in progress.”

例如，`Iterator`遍历可变集合时就不是线程安全的。
`Iterator`的规范说当用`Iterator`遍历一个可变集合时不能同时修改这个可变集合。这是对调用者的预设条件，且是时间相关的，当违反这个条件时，`Iterator`不保证有正确的行为。

当多个线程访问某个类时，不管运行时环境采用*何种调度方式或线程将如何交替执行*，且在主调代码中*不需要任何额外的同步或协同*，这个类都能*表现出正确的行为*，则称这个类是线程安全的。

## 正确性
线程安全的核心是*正确性（Correctness）* ：*类的行为和规范一致（conforms to its specification）*。


# 安全性

-   **可见性** - 线程修改了某个共享变量，其状态能够立即被其他线程知晓。通常被解释为将线程本地状态反映到主内存上，`volatile` 就是负责保证可见性的。
-   **原子性** - 多个操作要么全部成功要么全部失败。一般通过同步机制（加锁：`sychronized`、`Lock`）实现。
-   **有序性** - 是保证线程内串行语义，避免指令重排等。

