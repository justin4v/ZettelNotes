# 背景
- 加锁机制是实现线程安全的一种机制；
- 加锁机制主要用于保证多个操作的原子性。


# 内置锁
Java提供内置的锁机制支持原子性：**同步代码块（Synchronized Block）**。
Java对象自带一个*内置锁（Intrinsic Lock）* 也称作*监视器锁（Monitor Lock）*，加锁和解锁是 JVM 控制的。线程进入同步代码块之前需要获得锁，离开后自动释放锁。

# 重入
重入（*Reentrancy*）是指**一个线程可以再次获取已经获取到的锁**。

## 实现策略
Reentrancy：
1. 为每个锁关联一个获取计数器和所有者记录；
2. 计数器为0时，认为锁没有被线程持有；
3. 当线程 A 成功获取锁后，计数器加1，JVM 记录持有者线程 ID；
4. 当线程 B 尝试获取锁时，由于和持有者记录不匹配，线程 B 等待或进入阻塞；
5. 当线程 A 再次获取时，计数器加1；
6. 线程 A 退出同步代码块时，计数器递减，当计数器为0时，锁被释放。

## 示例
```java
public class Widget {
		public synchronized void doSomething() {
			...
		}
	}
public class LoggingWidget extends Widget {
	public synchronized void doSomething() {
		System.out.println(toString() + ": calling doSomething");
		super.doSomething();
	}
}
```