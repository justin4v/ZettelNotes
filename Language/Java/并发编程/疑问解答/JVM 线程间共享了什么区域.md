#Java基础 #JVM #Multi-threads #Thread-safe #TLAB  #Problem-and-Solutions 

# 线程
- 从代码角度看，线程的本质是函数的运行，stack 是每个线程（函数）独有的。
- JVM 中线程间共享 [[JVM内存结构#Heap|Heap]] 和 [[JVM内存结构#Method Area|Method Area]]；

## Heap 的常见结论
>1、堆是线程共享的内存区域，栈是线程独享的内存区域。
>2、堆中主要存放对象实例，栈中主要存放各种基本数据类型、对象的引用。
- 以上结论**并不是完全正确**的。


## Java对象的内存分配过程是如何保证线程安全的？
- *对象在创建时，都需要进行内存分配*。
- 对象的内存分配时，对象的引用（stack）指向内存区域（Heap），然后进行初始化操作.
- *堆是全局共享（JVM进程申请得到，由其中线程共享）*，同一时间，可能有多个线程在堆上申请空间，在并发场景中，可能存在*两个线程把对象引用指向了同一个内存区域*。

![[并发下的内存分配问题示意.png]]
- 为了解决这个并发问题，对象的内存分配过程就必须进行*同步控制*。
- 但是无论是使用哪种同步方案（如 CAS），都会影响内存的分配效率。
- HotSpot虚拟机的方案：
	- 每个线程在 Java 堆中*预先分配一小块内存*;
	- 然后再给*线程内对象*分配内存的时候，直接在这块*”私有”内存中分配*;
	- 当这部分区域用完之后，再分配新的”私有”内存。
	- 称之为 **TLAB(Thread Local Allocation Buffer) 分配**。
	- TLAB 是*从堆中划分*出来的，是*本地线程独享*的。


# TLAB


# 参考
1. [[JVM内存结构]]
2. [[JVM变量存储]]
3. [[2.线程]]
4. [[3.线程模型]]
5. [[1.进程]]
6. [Java堆内存是线程共享的！面试官：你确定吗？](https://cloud.tencent.com/developer/article/1597475)